version: '3'
services:
  db:
    image: mariadb:latest
    volumes:
      - './db:/var/lib/mysql'
    ports:
      - '3306:3306'
    environment:
        MYSQL_ROOT_PASSWORD: pods_csc
        MYSQL_DATABASE: pods_csc
        MYSQL_USER: pods_csc
        MYSQL_PASSWORD: pods_csc
        MYSQL_INITDB_SKIP_TZINFO: 1
  www:
    build: .
    entrypoint: /bin/bash
    command:
      - -c
      - |
        set -ex

        # If a INSTALLED file does not exist, perform a fresh install
        if [ ! -f /opt/drupal/INSTALLED ]; then

          # Wait for MySQL
          while ! mysqladmin ping -h db --silent; do
            sleep 1
          done

          # Delete the database volume.
          mysql -u pods_csc -h db -ppods_csc -e "DROP DATABASE pods_csc; CREATE DATABASE pods_csc"

          # Delete all files created by Composer.
          # This also deletes our custom modules and then restores them via Git.
          rm -rf /opt/drupal/.editorconfig /opt/drupal/.gitattributes /opt/drupal/keys /opt/drupal/vendor /opt/drupal/web
          (cd /opt/drupal/ && git checkout -- web)

          # Build the PODS CSC codebase via Composer.
          composer install

          # Install Drupal via Drush.
          drush site-install -y --existing-config --db-url=mysql://pods_csc:pods_csc@db/pods_csc --account-pass=admin farm farm.modules="base"

          # Make sites/default/files writable by Apache.
          chown -R root:www-data /opt/drupal/web/sites/default/files

          # Import taxonomy terms via Drush.
          drush -y import:taxonomies --choice=full
          
          # Add a test, npo, awardee, awardee1, and analyst users.
          drush user:create test --mail="test@example.com" --password="test"
          drush user:create npo --mail="npo@example.com" --password="npo"
          drush user:create awardee --mail="awardee@example.com" --password="awardee"
          drush user:create awardee1 --mail="awardee1@example.com" --password="awardee1"
          drush user:create analyst --mail="analyst@example.com" --password="analyst"

          # Assign drupal Roles to relevant user accounts.
          drush user:role:add 'nrcs_pods_csc_adminuser' npo
          drush user:role:add 'nrcs_pods_csc_user_awardee' awardee
          drush user:role:add 'nrcs_pods_csc_user_awardee' awardee1
          drush user:role:add 'nrcs_pods_csc_user_analyst' analyst

          # Create INSTALLED file
          touch /opt/drupal/INSTALLED
        fi

        # Notify that PODS CSC is ready.
        echo "##### PODS CSC IS READY #####"

        # Run Apache.
        apache2-foreground

    depends_on:
      - db
    volumes:
      - './:/opt/drupal'
    ports:
      - '85:80'
    environment:
      XDEBUG_MODE: debug
      XDEBUG_CONFIG: discover_client_host=yes
      XDEBUG_SESSION: PHPSTORM
